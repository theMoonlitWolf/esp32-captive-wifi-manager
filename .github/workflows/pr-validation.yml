on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

name: PR validation â€” Build, tests, static analysis

env:
  IDF_VERSION_RANGE: '>=5.5.0'

jobs:
  build:
    name: Build & validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set IDF_PATH and temporary wrapper base
        run: |
          echo "IDF_PATH=${RUNNER_TEMP}/esp-idf" >> $GITHUB_ENV
          echo "WRAPPER_BASE=${RUNNER_TEMP}/idf-wrapper" >> $GITHUB_ENV

      - name: Install helper packages (jq, dpkg, rsync, etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git wget make cmake ninja-build ccache python3 python3-pip python3-venv \
            build-essential libncurses-dev flex bison gperf libssl-dev cppcheck clang-format jq dpkg rsync || true

      - name: Resolve ESP-IDF tag from range (if any)
        run: |
          set -euo pipefail
          RANGE="${IDF_VERSION_RANGE:-}"
          if [ -z "$RANGE" ]; then
            echo "IDF_VERSION=v5.5.0" >> $GITHUB_ENV
            exit 0
          fi
          MIN_VERSION="${RANGE#>=}"
          MIN_VERSION="${MIN_VERSION#>}"
          MIN_VERSION="${MIN_VERSION#=}"
          MIN_VERSION="${MIN_VERSION#v}"
          TMP_TAGS="/tmp/esp-tags.txt"
          : > "${TMP_TAGS}"
          page=1
          while :; do
            resp="$(curl -sS "https://api.github.com/repos/espressif/esp-idf/tags?per_page=100&page=${page}")"
            len=$(echo "$resp" | jq 'length')
            if [ "$len" -eq 0 ]; then
              break
            fi
            echo "$resp" | jq -r '.[].name' >> "${TMP_TAGS}"
            page=$((page+1))
          done
          if [ ! -s "${TMP_TAGS}" ]; then
            echo "Failed to retrieve tags; falling back to v${MIN_VERSION}"
            echo "IDF_VERSION=v${MIN_VERSION}" >> $GITHUB_ENV
            exit 0
          fi
          sed 's/^v//' "${TMP_TAGS}" \
            | grep -E '^[0-9]+(\.[0-9]+){1,2}$' \
            | sort -V -r > /tmp/esp-tags.filtered
          chosen=""
          while read -r ver; do
            if dpkg --compare-versions "$ver" ge "$MIN_VERSION"; then
              chosen="$ver"
              break
            fi
          done < /tmp/esp-tags.filtered
          if [ -z "$chosen" ]; then
            chosen="${MIN_VERSION}"
          fi
          echo "Resolved tag: v${chosen}"
          echo "IDF_VERSION=v${chosen}" >> $GITHUB_ENV

      - name: Clone ESP-IDF (${IDF_VERSION})
        run: |
          echo "Cloning esp-idf ${IDF_VERSION} into ${IDF_PATH}"
          git clone --depth 1 --branch "${IDF_VERSION}" https://github.com/espressif/esp-idf.git "${IDF_PATH}"
          ls -la "${IDF_PATH}" || true

      - name: Install ESP-IDF Python requirements (guarded)
        run: |
          python3 -m pip install --upgrade pip || true
          if [ -f "${IDF_PATH}/requirements.txt" ]; then
            python3 -m pip install -r "${IDF_PATH}/requirements.txt"
          elif [ -f "${IDF_PATH}/tools/requirements.txt" ]; then
            python3 -m pip install -r "${IDF_PATH}/tools/requirements.txt"
          else
            echo "No requirements file found in esp-idf checkout; proceeding (may fail if deps missing)."
          fi

      - name: Run esp-idf install script (best-effort)
        run: |
          set -e
          if [ -x "${IDF_PATH}/install.sh" ]; then
            "${IDF_PATH}/install.sh" || echo "install.sh failed or required interaction; continuing"
          else
            echo "No install.sh present; skipping toolchain installer"
          fi

      - name: Build examples (try in-place; if fails, build via wrapper)
        shell: bash
        run: |
          set -euo pipefail
          source "${IDF_PATH}/export.sh"

          REPO_NAME="$(basename "${GITHUB_REPOSITORY}")"
          ROOT="$(pwd)"
          BUILT_ANY=0
          mkdir -p "${WRAPPER_BASE}"
          declare -a uploaded_paths=()

          # Helper to ensure wrapper contains the component
          ensure_wrapper_component() {
            COMPONENT_DIR="${WRAPPER_BASE}/components/${REPO_NAME}"
            if [ ! -d "${COMPONENT_DIR}" ]; then
              mkdir -p "${COMPONENT_DIR}"
              rsync -a --exclude='.git' --exclude='build' --exclude='.github' "${ROOT}/" "${COMPONENT_DIR}/"
            fi
            # Ensure minimal wrapper project root exists
            if [ ! -f "${WRAPPER_BASE}/CMakeLists.txt" ]; then
              cat > "${WRAPPER_BASE}/CMakeLists.txt" <<'EOF'
cmake_minimum_required(VERSION 3.16)
include($ENV{IDF_PATH}/tools/cmake/project.cmake)
project(ci_wrapper)
EOF
            fi
          }

          # If no examples directory, build the repository root (component or project)
          if [ ! -d examples ]; then
            echo "No examples directory found; attempting to build repo as a project or component wrapper."
            # If repo is a component, create wrapper and build wrapper/project
            if (grep -Iq "idf_component_register" CMakeLists.txt 2>/dev/null) || [ -f idf_component.yml ]; then
              echo "Detected component repo; building in wrapper"
              ensure_wrapper_component
              cd "${WRAPPER_BASE}"
              idf.py reconfigure || true
              idf.py build
              uploaded_paths+=("${WRAPPER_BASE}/build")
              BUILT_ANY=1
            else
              echo "Not a component repo; attempting to build at repo root"
              idf.py reconfigure || true
              idf.py build
              uploaded_paths+=("${ROOT}/build")
              BUILT_ANY=1
            fi
          else
            # iterate each example
            for ex in examples/*/ ; do
              [ -d "$ex" ] || continue
              exdir="${ex%/}"
              exname="$(basename "$exdir")"
              echo "=== Attempting to build example in-place: ${exname} ==="
              cd "${ROOT}/${exdir}"
              # attempt build in-place (this preserves relative includes)
              set +e
              idf.py reconfigure || true
              idf.py build
              rc=$?
              set -e
              if [ $rc -eq 0 ]; then
                echo "Example ${exname} built in-place successfully."
                uploaded_paths+=("${ROOT}/${exdir}/build")
                BUILT_ANY=1
                continue
              fi

              echo "In-place build for ${exname} failed (rc=${rc}). Falling back to wrapper build."

              # Prepare wrapper component and copy the example into wrapper/examples/<exname>
              ensure_wrapper_component
              mkdir -p "${WRAPPER_BASE}/examples/${exname}"
              rsync -a --exclude='.git' --exclude='build' --exclude='.github' "${ROOT}/${exdir}/" "${WRAPPER_BASE}/examples/${exname}/"
              echo "Building example ${exname} inside wrapper..."
              cd "${WRAPPER_BASE}/examples/${exname}"
              idf.py reconfigure || true
              idf.py build
              if [ $? -eq 0 ]; then
                echo "Wrapper build for ${exname} succeeded."
                uploaded_paths+=("${WRAPPER_BASE}/examples/${exname}/build")
                BUILT_ANY=1
              else
                echo "Wrapper build for ${exname} FAILED. Leaving logs for debugging."
                # continue to next example; do not fail the whole step immediately
              fi
            done
          fi

          # Print summary and export artifact paths
          if [ "${#uploaded_paths[@]}" -eq 0 ]; then
            echo "No builds succeeded for any example or project."
            exit 1
          fi

          echo "Built paths:"
          for p in "${uploaded_paths[@]}"; do
            echo " - $p"
          done

          # Persist paths for next steps (newline-separated)
          printf "%s\n" "${uploaded_paths[@]}" > /tmp/built_paths.txt
          echo "BUILT_PATHS=/tmp/built_paths.txt" >> $GITHUB_ENV

      - name: Upload build artifacts (project + examples builds)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: esp-build
          path: |
            build/
            examples/*/build/
            ${{ env.WRAPPER_BASE }}/examples/*/build/
            ${{ env.WRAPPER_BASE }}/build/
