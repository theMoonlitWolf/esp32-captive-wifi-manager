on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

name: PR validation â€” Build, tests, static analysis

# Set IDF version here (use tag form, e.g. v5.5.0)
env:
  IDF_VERSION: 'v5.5.0'

jobs:
  build:
    name: Build & validate
    runs-on: ubuntu-latest
    # runner.* contexts are only available at job/step scope, so set IDF_PATH here.
    env:
      IDF_PATH: ${{ runner.temp }}/esp-idf
      IDF_VERSION: ${{ env.IDF_VERSION }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install system packages (apt)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git wget make cmake ninja-build ccache python3 python3-pip python3-venv \
            build-essential libncurses-dev flex bison gperf libssl-dev cppcheck clang-format jq dpkg || true

      - name: Clone ESP-IDF (${IDF_VERSION})
        run: |
          echo "Cloning esp-idf ${IDF_VERSION} into ${IDF_PATH}"
          git clone --depth 1 --branch "${IDF_VERSION}" https://github.com/espressif/esp-idf.git "${IDF_PATH}"
          ls -la "${IDF_PATH}"

      - name: Install ESP-IDF Python requirements
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r "${IDF_PATH}/requirements.txt"

      - name: Run esp-idf install script (best-effort, may download toolchains)
        run: |
          set -e
          if [ -x "${IDF_PATH}/install.sh" ]; then
            "${IDF_PATH}/install.sh" || echo "install.sh failed or required interaction; continuing"
          else
            echo "No install.sh present or not executable; skipping"
          fi

      - name: Build (source IDF environment and run idf.py)
        shell: bash
        run: |
          source "${IDF_PATH}/export.sh"
          # set target if needed: idf.py set-target esp32
          idf.py reconfigure || true
          idf.py build
          idf.py size-components || true

      - name: Run unit tests (pytest) if tests/ exists
        shell: bash
        run: |
          if [ -d tests ]; then
            python3 -m pip install pytest || true
            pytest -q tests || (echo "pytest failures" && exit 1)
          else
            echo "No tests/ dir found; skipping pytest"
          fi

      - name: Static analysis (cppcheck) if compile_commands.json exists
        shell: bash
        run: |
          if [ -f build/compile_commands.json ]; then
            cppcheck --project=build/compile_commands.json --enable=warning,performance,portability --error-exitcode=1
          else
            echo "No build/compile_commands.json found; skipping cppcheck"
          fi

      - name: Check formatting with clang-format (optional, fails on mismatch)
        shell: bash
        run: |
          if command -v clang-format >/dev/null 2>&1 && [ -f .clang-format ]; then
            mismatches=0
            git ls-files '*.c' '*.cpp' '*.h' '*.hpp' | while read -r f; do
              tmp=$(mktemp)
              clang-format --style=file "$f" > "$tmp"
              if ! diff -q "$f" "$tmp" >/dev/null 2>&1; then
                echo "clang-format mismatch: $f"
                diff -u "$f" "$tmp" || true
                mismatches=1
              fi
              rm "$tmp"
            done
            if [ "$mismatches" -ne 0 ]; then
              echo "clang-format mismatches detected"
              exit 1
            fi
            echo "clang-format OK"
          else
            echo "clang-format or .clang-format not available; skipping format check"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp-build
          path: build/
