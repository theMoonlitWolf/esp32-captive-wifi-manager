<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ESP32 Wi-Fi Setup</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f9f9f9;margin:2em}
    form{background:#fff;padding:2em;border-radius:8px;max-width:400px;margin:auto}
    label{display:block;margin-top:1em}
    input[type=text],input[type=password],select{width:96%;padding:.5em}
    .section{margin-bottom:1.5em}
    button{margin-top:1.5em;padding:.7em 2em}
    #refreshBtn{margin:0;padding:0;font-size:1em;height:1.8em;width:1.8em;min-width:0;border-radius:20%;display:flex;justify-content:center;align-items:center}
    .ssid-row{display:flex;gap:.5em;align-items:center}
    .warning{color:orange;margin-top:.5em;font-size:.9em;display:none}
    .warning.red{color:red}
  </style>
</head>
<body>
  <h2>ESP32 Captive Portal Setup</h2>
  <form method="POST" action="/captive">
    <div id="dataWarn" class="warning red">⚠️ Failed to load settings. Please check your connection.</div>
    <div class="section">
      <label for="ssid">Wi-Fi SSID:</label>
      <div class="ssid-row">
        <select id="ssid" name="ssid" required style="flex:1" onchange="updateAuthmode(this)">
          <option value="" disabled selected>Loading...</option>
        </select>
        <button type="button" id="refreshBtn" title="Refresh Wi-Fi list">⟳</button>
      </div>
      <div id="scanWarn" class="warning red">⚠️ Wi-Fi scan failed. Please enter SSID manually if needed.</div>
      <div id="enterpriseWarn" class="warning">⚠️ Enterprise networks are not supported. Please select a different network.</div>
      <div id="password_field" style="display:block">
        <label for="password">Wi-Fi Password:</label>
        <input type="password" id="password" name="password">
      </div>
      <input type="hidden" id="authmode" name="authmode" value="">
    </div>
    <div class="section">
      <label><input type="checkbox" id="use_static_ip" name="use_static_ip" value="true" onchange="toggle('static_ip_fields',this.checked)">Use Static IP</label>
      <div id="static_ip_fields" style="display:none">
        <label for="static_ip">Static IP Address:</label>
        <input type="text" id="static_ip" name="static_ip">
      </div>
    </div>
    <div class="section">
      <label><input type="checkbox" id="use_mDNS" name="use_mDNS" value="true" onchange="toggle('mdns_fields',this.checked)">Enable mDNS</label>
      <div id="mdns_fields" style="display:none">
        <label for="mDNS_hostname">mDNS Hostname:</label>
        <input type="text" id="mDNS_hostname" name="mDNS_hostname">
        <label for="service_name">Service Name:</label>
        <input type="text" id="service_name" name="service_name">
      </div>
    </div>
    <button type="submit" id="saveBtn">Save & Connect</button>
  </form>
  <script>
    const g=id=>document.getElementById(id);
    function toggle(id,show){g(id).style.display=show?'block':'none'}
    function updateAuthmode(sel){
      const pwd=g('password_field'),ent=g('enterpriseWarn'),btn=g('saveBtn'),auth=g('authmode');
      if(!sel.options||!sel.options[sel.selectedIndex]||!sel.options[sel.selectedIndex].getAttribute('data-authmode')){
        pwd.style.display='block';ent.style.display='none';auth.value='';btn.disabled=false;
        console.warn('updateAuthmode: no valid selection');
        return;
      }
      const mode=+sel.options[sel.selectedIndex].getAttribute('data-authmode');
      console.log('updateAuthmode: mode='+mode+', ssid='+sel.value);
      if(mode===0){pwd.style.display='none';ent.style.display='none';auth.value=0;btn.disabled=false}
      else if(mode===2){pwd.style.display='none';ent.style.display='block';auth.value=2;btn.disabled=true}
      else{pwd.style.display='block';ent.style.display='none';auth.value=1;btn.disabled=false}
    }
    function populateSSIDs(aps,sel,auth){
      console.log('populateSSIDs: '+aps.length+' APs, looking for ssid='+sel+', auth='+auth);
      let s=g('ssid');
      // Reset to select if it was converted to input on previous scan fail
      if(s.tagName.toLowerCase()==='input'){
        console.log('populateSSIDs: converting input back to select');
        const newSel=document.createElement('select');
        newSel.id='ssid';newSel.name='ssid';newSel.required=true;newSel.style.flex='1';
        newSel.onchange=function(){updateAuthmode(this)};
        s.parentNode.replaceChild(newSel,s);
        s=newSel;
      }
      let found=false;
      s.innerHTML='';
      aps.forEach(ap=>{
        const o=document.createElement('option');
        o.value=ap.ssid;
        const l=ap.authmode===0?'Open':ap.authmode===2?'Enterprise':'WPA/WPA2';
        o.textContent=`${ap.ssid} RSSI: ${ap.rssi}dBm, Auth: ${l}`;
        o.setAttribute('data-authmode',ap.authmode);
        if(ap.ssid===sel&&ap.authmode==auth){o.selected=true;found=true}
        s.appendChild(o);
      });
      if(!found&&sel){
        const o=document.createElement('option');
        const l=auth===0?'Open':auth===2?'Enterprise':'WPA/WPA2';
        o.value=sel;
        o.textContent=`${sel} (unavailable), Auth: ${l}`;
        o.selected=true;
        o.setAttribute('data-authmode',auth);
        s.appendChild(o);
      }
      if(!found&&!sel){
        const o=document.createElement('option');
        o.value='';
        o.textContent='Select SSID';
        o.selected=true;
        o.disabled=true;
        s.appendChild(o);
      }
      s.required=true;
      updateAuthmode(s);
      g('saveBtn').textContent='Save & Connect';
      g('scanWarn').style.display='none';
      console.log('populateSSIDs: complete, found='+found);
    }
    function getSSIDs(sel,auth){
      console.log('getSSIDs: fetching scan.json for ssid='+sel);
      const ctrl=new AbortController();
      setTimeout(()=>ctrl.abort(),5000);
      fetch('/scan.json',{signal:ctrl.signal})
        .then(r=>r.json())
        .then(d=>{console.log('getSSIDs: received '+d.aps.length+' APs');populateSSIDs(d.aps||[],sel,auth)})
        .catch(e=>{
          console.error('getSSIDs: scan failed - '+e);
          let s=g('ssid');
          if(s.tagName.toLowerCase()==='select'){
            console.log('getSSIDs: converting select to input for manual entry');
            const i=document.createElement('input');
            i.type='text';i.id='ssid';i.name='ssid';i.value=sel||'';i.placeholder='Enter SSID';i.required=false;
            s.parentNode.replaceChild(i,s);
          }
          g('saveBtn').textContent='Save (no SSID available)';
          g('scanWarn').style.display='block';
        });
    }
    function loadSettings(){
      console.log('loadSettings: fetching captive.json');
      g('dataWarn').style.display='none';
      fetch('/captive.json')
        .then(r=>r.json())
        .then(c=>{
          console.log('loadSettings: loaded config - ssid='+c.ssid+', authmode='+c.authmode+', static_ip='+c.use_static_ip+', mDNS='+c.use_mDNS);
          getSSIDs(c.ssid||'',c.authmode||'');
          if(c.password){g('password').value='';g('password').placeholder='(unchanged)'}
          g('use_static_ip').checked=!!c.use_static_ip;
          g('static_ip').value=c.static_ip||'';
          toggle('static_ip_fields',c.use_static_ip);
          g('use_mDNS').checked=!!c.use_mDNS;
          g('mDNS_hostname').value=c.mDNS_hostname||'';
          g('service_name').value=c.service_name||'';
          toggle('mdns_fields',c.use_mDNS);
        })
        .catch(e=>{console.error('loadSettings: failed - '+e);g('dataWarn').style.display='block'});
    }
    g('refreshBtn').onclick=()=>{console.log('Refresh button clicked');loadSettings();getSSIDs(g('ssid').value)};
    window.onload=loadSettings;
  </script>
</body>
</html>