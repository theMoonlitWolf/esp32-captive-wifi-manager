<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>RC Car Control</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/styles.css">
</head>

<body>
  <div id="nav"></div> <!-- Navigation will be loaded here by common.js -->
  <div class="card">
    <h1>WebSocket control example</h1>
    <div class="message"></div> <!-- Status messages will be displayed here by common.js -->
    
    <!-- Binary sending example -->
    <div class="slider-group">
      <div class="slider-label-row">
        <label for="sliderBin">Slider (Binary):</label>
        <span class="value" id="sliderBinValue">0</span>
      </div>
      <input type="range" id="sliderBin" min="0" max="255" value="0">
    </div>

    <!-- JSON sending example -->
    <div class="slider-group">
      <div class="slider-label-row">
        <label for="sliderJson">Slider (JSON):</label>
        <span class="value" id="sliderJsonValue">0</span>
      </div>
      <input type="range" id="sliderJson" min="0" max="1023" value="0">
    </div>

    <!-- Text input example -->
    <div class="text-input-group">
      <label for="textinput">Text Input:</label>
      <input type="text" id="textinput" value="Hello, ESP32!">
      <button id="sendTextBtn">Send</button>
  </div>

  <footer id="status"></footer>
  <script src="common.js"></script>
  <script src="ws.js"></script>
  <script>

    // Binary slider change handling
    function sendSliderBinary(value) {
      document.getElementById('sliderBinValue').textContent = value;
      sendWSBinary(WS_value.SLIDER_BINARY, value);
    }
    // Event listener for slider input
    document.getElementById('sliderBin').addEventListener('input', e => {
      sendSliderBinary(e.target.value);
    });

    // JSON slider change handling
    function sendSliderJSON(value) {
      document.getElementById('sliderJsonValue').textContent = value;
      sendWSMessage(JSON.stringify({ slider: Number(value) }));
    }
    // Event listener for slider input
    document.getElementById('sliderJson').addEventListener('input', e => {
      sendSliderJSON(e.target.value);
    });

    // Text input sending handling
    function sendTextInput() {
      const text = document.getElementById('textinput').value;
      sendWSMessage(text);
    }
    // Event listener for button click
    document.getElementById('sendTextBtn').addEventListener('click', () => {
      sendTextInput();
    });

    function update() {
      if (ws.readyState === WebSocket.OPEN) {
        sendWSEvent(WS_event.EVENT_RELOAD);
      } else {
        console.warn('WebSocket not connected, reloading from JSON');
        fetch('/status.json')
          .then(response => response.json())
          .then(data => {
            // Update sliders from JSON data
            if (data.slider !== undefined) {
              const sliderJson = document.getElementById('sliderJson');
              const sliderJsonValue = document.getElementById('sliderJsonValue');
              sliderJson.value = data.slider;
              sliderJsonValue.textContent = data.slider;
            }
            if (data.slider_binary !== undefined) {
              const sliderBin = document.getElementById('sliderBin');
              const sliderBinValue = document.getElementById('sliderBinValue');
              sliderBin.value = data.slider_binary;
              sliderBinValue.textContent = data.slider_binary;
            }
          })
          .catch(error => {
            console.error('Error fetching status JSON:', error);
          });
      }
    }

    // Handle incoming binary messages (pre-parsed by ws.js into type and value)
    window.handleWSBinaryData = function(type, value) {
      switch (type) {
        case WS_value.SLIDER_BINARY:
          // clamp to 0..255 for the binary slider control
          let val = Math.max(0, Math.min(255, value));
          const sliderb = document.getElementById('sliderBin');
          const sliderbv = document.getElementById('sliderBinValue');
          if (sliderb) sliderb.value = val;
          if (sliderbv) sliderbv.textContent = val;
          console.log('Binary slider updated to', val);
          break;
        case WS_value.SLIDER_JSON:
          // clamp to 0..1023 for the JSON slider control
          let jval = Math.max(0, Math.min(1023, value));
          const sliderj = document.getElementById('sliderJson');
          const sliderjv = document.getElementById('sliderJsonValue');
          if (sliderj) sliderj.value = jval;
          if (sliderjv) sliderjv.textContent = jval;
          console.log('JSON slider updated to', jval);
          break;
        default:
          console.log('Unknown binary message type', type);
          break;
      }
    }

    // Handle incoming events (1-byte messages)
    window.handleWSEvent = function(eventType) {
      // No need to handle any events for now, add as needed
    }

    window.handleWSText = function(message) {
      // Display received text message
      message('info', 'Message received: ' + message, 3000);
    }

    setInterval(update, 5000);
    update();
  </script>
</body>
</html>